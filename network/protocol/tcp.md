# tcp 协议

## 首部协议格式

二进制从上到下依次排列。

- 16 位源端口号
- 16 位目的端口号
- 32 位序号
- 32 位确认序号
- 4 位首部长度
  - 给出首部中 32 bit 字（4byte）的数目
  - (2^4-1)*4=15*4=60 。必填首部大小为 20byte，因此其他选项最多包含 30byte 的大小
- 6 位保留位
- 6 位标志位
  - 它们中的多个可同时被设置为 1
  - URG
    - 紧急指针有效
  - ACK
    - 确认需要有效
  - PSH
    - 接收方应该尽快把这个报文交给应用层
  - RST
    - 重新连接
  - SYN
    - 同步序号。用来发起一个连接
  - FIN
    - 源端完成发送任务。结束连接
- 16 位窗口大小
  - tcp 缓冲区的大小
- 16 位校验和
  - 校验数据是否失真
  - T C P 首部和 T C P 数据。这是一个强制性的字段，一定是由源端计算和存储，并由目的端进行验证
- 16 位紧急指针
  - ？
- 其他选项

## FAQ

1. 建立连接的三次握手和断开连接的四次挥手？

TCP 为全双工的连接。断开的时候需要双方的确认。源端发起连接请求，并且把当前的序列号同步给目的端（SYN 标志位置为 1，把当前序列号填充进序号首部），目的端接收到连接的请求，把目的端这边的序列号同步给源端（ACK 标志位置为 1，并且把当前序号填充进序号首部，把请求的序号序列加 1 标识期望下一次接收的序号起始值），源端收到目的端的确认信息，发送确认信息给目的端（ACK 置为 1，确认序号首部为收到的信息的序号加 1），至此，一个 tcp 连接完成。之后每次进行数据交互的时候都【序号】和【确认序号】。断开连接，源端发送断开连接的请求（FIN 置为 1），表示源端已经没有数据要发送，但是还可以接收数据，目的端接收到请求，发送确认信息（ACK 置为 1），表示收到断开的请求，当源端把缓冲区的数据发送万之后，也会想源端发起一个请求（FIN 置为 1），表示需要断开连接不再发送数据，源端收到请求，回复一个确认信息，至此双方完全断开连接。

2. 源端能否在未收到上一次发送的确认信号之前再次发送数据包？
